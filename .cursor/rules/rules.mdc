---
description: Diretrizes T√©cnicas para Intera√ß√£o com IA no ModularOne
globs: "**/*"
alwaysApply: true
version: 2.1.1
# üîç An√°lise de C√≥digo (AST Level)

## Fluxo de Compreens√£o
```mermaid
graph TD
  A[An√°lise L√©xica] --> B[Parse AST]
  B --> C[Mapa de Depend√™ncias]
  C --> D[Padr√µes Arquiteturais]
  D --> E[Relat√≥rio de Complexidade]
```

## Modelo de Diagn√≥stico
```ts
interface CodeAnalysis {
  id: string;
  severity: 1 | 2 | 3;
  category: 'security' | 'performance' | 'maintainability';
  location: {
    file: string;
    line: number;
    column: number;
  };
  suggestion: string;
  references: string[];
  metrics: {
    cyclomatic: number;
    cognitive: number;
    halstead: number;
  };
}
```

## Checklist de An√°lise
- [ ] Mapear depend√™ncias cruzadas
- [ ] Identificar code smells
- [ ] Calcular m√©tricas de complexidade
- [ ] Verificar viola√ß√µes de padr√µes
- [ ] Validar consist√™ncia arquitetural
```

# üèó Arquitetura & Padr√µes de C√≥digo

## Princ√≠pios SOLID Adaptados
```mermaid
graph LR
  S(SRP) -->|Uma responsabilidade| O(OCP)
  O -->|Extens√£o aberta| L(LSP)
  L -->|Substitui√ß√£o| I(ISP)
  I -->|Segrega√ß√£o| D(DIP)
  D -->|Invers√£o| S
```

## Implementa√ß√£o de Componentes
```ts
interface ComponentRules {
  naming: {
    prefix: string;
    pattern: 'PascalCase' | 'kebab-case';
    suffix?: 'Container' | 'Widget';
  };
  props: {
    validation: 'Zod' | 'Yup';
    typing: 'Strict' | 'Optional';
    defaults: 'Required' | 'Partial';
  };
  styling: 'Tailwind' | 'CSSModules';
  testing: {
    unit: 'Jest' | 'Vitest';
    coverage: number;
  };
}
```

## Checklist de Qualidade
- [ ] Atender aos princ√≠pios SOLID
- [ ] Seguir padr√µes de projeto adequados
- [ ] Manter coes√£o alta (‚â•80%)
- [ ] Limitar acoplamento (‚â§3 depend√™ncias)
- [ ] Implementar testes unit√°rios
- [ ] Documentar via TSdoc
```

# üîí Seguran√ßa & Boas Pr√°ticas

## Princ√≠pios Fundamentais
```mermaid
graph TD
  A[Seguran√ßa] --> B[Defesa em Profundidade]
  A --> C[Princ√≠pio do Menor Privil√©gio]
  A --> D[Valida√ß√£o Rigorosa]
  B --> E[Multi-factor Authentication]
  C --> F[Controle de Acesso Granular]
  D --> G[Sanitiza√ß√£o de Dados]
  D --> H[Gest√£o Segura de Credenciais de API]
```

## Checklist Cr√≠tico
- [ ] Valida√ß√£o de inputs com Zod
- [ ] Sanitiza√ß√£o de dados antes do processamento
- [ ] Controle de acesso baseado em roles (RBAC)
- [ ] Logging n√£o sens√≠vel com m√°scara de dados
- [ ] Tratamento de erros sem expor detalhes internos
- [ ] Criptografia de dados sens√≠veis em repouso/tr√¢nsito
- [ ] Auditoria peri√≥dica de permiss√µes
- [ ] Rota√ß√£o de chaves de API

## Padr√µes de Seguran√ßa
```ts
// Modelo de Autentica√ß√£o Segura
interface AuthConfig {
  jwtSecret: string;
  sessionTimeout: number;
  passwordPolicy: {
    minLength: number;
    complexity: boolean;
    historyCheck: number;
  };
  mfa: {
    enabled: boolean;
    methods: ['sms', 'email', 'authenticator'];
  };
}

class AuthService {
  private async handleAuthFlow(
    credentials: SecureAuthPayload,
    context: AuthContext
  ) {
    // Implementa√ß√£o com valida√ß√£o em m√∫ltiplos n√≠veis
  }
}
```

## Fluxo de Autentica√ß√£o
```mermaid
sequenceDiagram
  participante User
  participante Frontend
  participante Backend
  User->>Frontend: Insere credenciais
  Frontend->>Backend: Challenge criptografado
  Backend->>Frontend: Token JWT assinado
  Frontend->>User: Redirecionamento seguro
```

# üõ† Implementa√ß√£o & Testes

## Fluxo de Valida√ß√£o
```mermaid
graph TD
  A[An√°lise de Requisitos] --> B[Proposta T√©cnica]
  B --> C[Revis√£o com Dev]
  C --> D[Implementa√ß√£o Parcial]
  D --> E[Testes Automatizados (Unit√°rios, Integra√ß√£o como test_growatt_integration.ts)]
  E --> F{Passou?}
  F -->|Sim| G[Implementa√ß√£o Completa]
  F -->|N√£o| H[Refatora√ß√£o]
  G --> I[Documenta√ß√£o Atualizada]
  H --> D
```

## Implementa√ß√£o de Testes
```ts
// Exemplo de Teste Unit√°rio (AuthService - Login)
// describe('AuthService', () => { ... }); // Mantido como exemplo de teste unit√°rio

// Exemplo de Teste de Integra√ß√£o (API Growatt - Pseudoc√≥digo)
/**
 * O script 'supabase/scripts/test_growatt_integration.ts' serve como um exemplo pr√°tico.
 * Ele utiliza Deno e as bibliotecas Supabase para:
 * 1. Carregar vari√°veis de ambiente (Supabase URL, Anon Key, credenciais Growatt de teste).
 * 2. Simular a l√≥gica de obten√ß√£o e hash de senha da Edge Function.
 * 3. Chamar diretamente a API da Growatt com as credenciais processadas.
 * 4. Validar a resposta da API (e.g., verificar se o login foi bem-sucedido e se plantas s√£o listadas).
 * Este script permite testar a integra√ß√£o com a API Growatt independentemente do fluxo completo da aplica√ß√£o.
 */
describe('GrowattAPIIntegration', () => {
  it('deve autenticar e listar plantas com sucesso usando credenciais de teste', async () => {
    // L√≥gica similar √† encontrada em test_growatt_integration.ts
    // 1. Obter username/password de teste.
    // 2. Calcular o hash MD5 da senha (como feito na Edge Function).
    // 3. Montar a requisi√ß√£o para a API Growatt.
    // 4. Realizar a chamada √† API.
    // 5. Assertar que a resposta indica sucesso e cont√©m os dados esperados.
    // Exemplo: expect(response.error_code).toBe(0);
  });
});
```

## Checklist de Qualidade de Testes
- [ ] Cobrir casos de sucesso e falha (incluindo c√≥digos de erro esperados de APIs externas).
- [ ] Testar valores limite e entradas inv√°lidas.
- [ ] Mockar depend√™ncias externas quando o foco √© a l√≥gica unit√°ria; para testes de integra√ß√£o, usar ambientes de teste ou contas de sandbox quando poss√≠vel.
- [ ] Garantir velocidade de execu√ß√£o (especialmente para testes unit√°rios; testes de integra√ß√£o podem ser mais lentos mas devem ser gerenci√°veis).

## Padr√µes de Teste
| Tipo        | Boas Pr√°ticas                      | Anti-padr√µes                |
|-------------|------------------------------------|-----------------------------|
| Unit√°rio    | Testes isolados e r√°pidos          | Mockar excessivamente       |
| Integra√ß√£o  | Testar fluxos completos entre componentes ou com sistemas externos (e.g., `test_growatt_integration.ts`) | Depender de dados externos inst√°veis sem mocks adequados para outros cen√°rios; Testes excessivamente fr√°geis a mudan√ßas na UI para integra√ß√µes de backend. |
| E2E         | Simular intera√ß√µes reais do usu√°rio  | Testes fr√°geis/lentos       |

# üìÑ Formato de Respostas

## Template Estruturado
```markdown
## An√°lise do Problema
- Contexto atual (o que est√° acontecendo, onde, desde quando)
- Impacto estimado (quantos usu√°rios/sistemas afetados, severidade)
- Componentes afetados (fun√ß√µes, tabelas, m√≥dulos espec√≠ficos)
- Causa raiz preliminar (hip√≥teses iniciais)

## Proposta de Solu√ß√£o
```ts
// Exemplo de implementa√ß√£o da corre√ß√£o ou nova funcionalidade
function solucaoOtimizada(...args) {
  // L√≥gica da solu√ß√£o...
}
```

## Passos para Implementa√ß√£o
1. Prepara√ß√£o (e.g., backup, configura√ß√£o de ambiente)
2. Altera√ß√µes no c√≥digo (detalhar arquivos e fun√ß√µes)
3. Migra√ß√µes de banco de dados (se houver)
4. Deploy (comandos, sequ√™ncia)
5. Configura√ß√µes adicionais

## Estrat√©gia de Testes e Valida√ß√£o
- Testes unit√°rios a serem adicionados/modificados.
- Testes de integra√ß√£o (e.g., como validar com a API Growatt usando o script `test_growatt_integration.ts`).
- Testes manuais e crit√©rios de aceite.

## Considera√ß√µes
- Trade-offs t√©cnicos (performance, complexidade, seguran√ßa)
- Alternativas descartadas (e porqu√™)
- Riscos potenciais e plano de mitiga√ß√£o/rollback
- Impacto na documenta√ß√£o e necessidade de atualiza√ß√£o.

*Nota: O documento `docs/solucao_problema_api_growatt.md` serve como um exemplo pr√°tico da aplica√ß√£o desta estrutura para documentar a resolu√ß√£o de um problema espec√≠fico.*
```

# üîÑ Adapta√ß√£o ao Projeto

## Diretrizes de Evolu√ß√£o
1. **Versionamento Sem√¢ntico**  
   `MAJOR.MINOR.PATCH` com changelog detalhado. Migra√ß√µes de banco de dados seguem timestamp e nome descritivo (e.g., `<timestamp>_correct_growatt_api_schema.sql`).

2. **Gest√£o de Depend√™ncias**  
   ```bash
   # Atualiza√ß√£o segura
   npm update --audit --fund
   # Manter o m√≠nimo de depend√™ncias poss√≠vel.
   # Ex: Substitui√ß√£o de js-md5 pela API crypto nativa para hashing MD5.
   ```

3. **Ambientes Multi-stage**  
   ```env
   # .env.production
   API_URL=https://api.prod.modularone.com
   DEBUG_MODE=false
   ```

# ‚úÖ Mecanismos de Valida√ß√£o

## Checklist de Qualidade
1. [ ] Documenta√ß√£o inline (TSDoc/JSDoc para fun√ß√µes e l√≥gica complexa)
2. [ ] Tipagem est√°tica completa e precisa com TypeScript
3. [ ] Testes automatizados (unit√°rios e de integra√ß√£o cobrindo funcionalidades chave e intera√ß√µes com APIs)
4. [ ] Compatibilidade cross-browser (para componentes de frontend)
5. [ ] Acessibilidade (WCAG 2.1)

## Indicadores de Performance
| M√©trica          | Aceit√°vel  | Ideal     |
|------------------|------------|-----------|
| TTI (s)         | ‚â§3        | ‚â§1        |
| CLS              | ‚â§0.1      | ‚â§0.05     |
| Mem√≥ria (MB)     | ‚â§500      | ‚â§200      |

| CLS              | ‚â§0.1      | ‚â§0.05     |
| Mem√≥ria (MB)     | ‚â§500      | ‚â§200      |
